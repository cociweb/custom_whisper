name: Build Standalone

on:
  push:
    branches:
      - main
    tags: [ 'v*.*.*' ]

jobs:
  push_to_registries:
    name: Build Standalone
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    strategy:
      matrix:
        addon: ["standalone_whisper"]
        device: ["cpu", "cuda"]
        arch: ["aarch64", "amd64"]

    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3.0.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.ACTION_TOKEN }}

      - uses: mr-smithers-excellent/docker-build-push@v6
#        if: github.event_name == 'push' && contains(github.ref, '/tags/v')
        name: "Build & push Standalone Docker image: ${{ matrix.arch }}-${{ matrix.device }}"
        with:
          image: "${{ matrix.arch }}_${{ matrix.device }}-${{ matrix.addon }}"
          dockerfile: "${{ matrix.addon }}/${{ matrix.device }}/Dockerfile"
          tags: latest
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.ACTION_TOKEN }}
          pushImage: true
